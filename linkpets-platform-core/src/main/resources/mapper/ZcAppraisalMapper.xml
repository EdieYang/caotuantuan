<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.linkpets.core.dao.ZcAppraisalMapper">
  <resultMap id="BaseResultMap" type="com.linkpets.core.model.ZcAppraisal">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Sun Aug 11 14:03:03 GMT+08:00 2019.
    -->
    <id column="appraisal_id" jdbcType="VARCHAR" property="appraisalId" />
    <result column="title" jdbcType="VARCHAR" property="title" />
    <result column="create_by" jdbcType="VARCHAR" property="createBy" />
    <result column="create_time" jdbcType="TIMESTAMP" property="createTime" />
    <result column="is_valid" jdbcType="INTEGER" property="isValid" />
  </resultMap>
  <resultMap extends="BaseResultMap" id="ResultMapWithBLOBs" type="com.linkpets.core.model.ZcAppraisal">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Sun Aug 11 14:03:03 GMT+08:00 2019.
    -->
    <result column="content" jdbcType="LONGVARCHAR" property="content" />
  </resultMap>
  <sql id="Base_Column_List">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Sun Aug 11 14:03:03 GMT+08:00 2019.
    -->
    appraisal_id, title, create_by, create_time, is_valid
  </sql>
  <sql id="Blob_Column_List">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Sun Aug 11 14:03:03 GMT+08:00 2019.
    -->
    content
  </sql>
  <insert id="insertSelective" parameterType="com.linkpets.core.model.ZcAppraisal">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Sun Aug 11 14:03:03 GMT+08:00 2019.
    -->
    insert into zc_appraisal
    <trim prefix="(" suffix=")" suffixOverrides=",">
      <if test="appraisalId != null">
        appraisal_id,
      </if>
      <if test="title != null">
        title,
      </if>
      <if test="createBy != null">
        create_by,
      </if>
      <if test="createTime != null">
        create_time,
      </if>
      <if test="isValid != null">
        is_valid,
      </if>
      <if test="content != null">
        content,
      </if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides=",">
      <if test="appraisalId != null">
        #{appraisalId,jdbcType=VARCHAR},
      </if>
      <if test="title != null">
        #{title,jdbcType=VARCHAR},
      </if>
      <if test="createBy != null">
        #{createBy,jdbcType=VARCHAR},
      </if>
      <if test="createTime != null">
        #{createTime,jdbcType=TIMESTAMP},
      </if>
      <if test="isValid != null">
        #{isValid,jdbcType=INTEGER},
      </if>
      <if test="content != null">
        #{content,jdbcType=LONGVARCHAR},
      </if>
    </trim>
  </insert>
  <update id="updateByPrimaryKeySelective" parameterType="com.linkpets.core.model.ZcAppraisal">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Sun Aug 11 14:03:03 GMT+08:00 2019.
    -->
    update zc_appraisal
    <set>
      <if test="title != null">
        title = #{title,jdbcType=VARCHAR},
      </if>
      <if test="createBy != null">
        create_by = #{createBy,jdbcType=VARCHAR},
      </if>
      <if test="createTime != null">
        create_time = #{createTime,jdbcType=TIMESTAMP},
      </if>
      <if test="isValid != null">
        is_valid = #{isValid,jdbcType=INTEGER},
      </if>
      <if test="content != null">
        content = #{content,jdbcType=LONGVARCHAR},
      </if>
    </set>
    where appraisal_id = #{appraisalId,jdbcType=VARCHAR}
  </update>
  
  <select id="getList" resultType="java.util.Map">
	SELECT 
	  t_a.appraisal_id AS appraisalId,
	  t_a.title AS title,
	  t_a.content AS content,
	  t_a.create_by AS createBy,
	  t_cr.nick_name AS creatorName,
	  t_cr.portrait,
	  DATE_FORMAT(
	    t_a.create_time,
	    '%Y-%m-%d %H:%i:%s'
	  ) AS createTime,
	  t_ai.img,
	  t_aa.appreciateCount,
	  t_aa.appreciateFlag,
	  t_af.favoriteCount,
	  t_af.favoriteFlag,
	  t_at.tag,
	  t_ac.commodityName,
	  t_ac.brandName 
	FROM
	  zc_appraisal t_a 
	  LEFT JOIN (SELECT 
		  appraisal_id,
		  COUNT(DISTINCT user_id) AS appreciateCount,
		  SUM(CASE user_id WHEN #{userId,jdbcType=VARCHAR} THEN 1 ELSE 0 END) AS appreciateFlag
		FROM
		  zc_appraisal_appreciate 
		WHERE is_vaild = 1 
		GROUP BY appraisal_id ) t_aa
	    ON t_a.appraisal_id = t_aa.appraisal_id 
	  LEFT JOIN (SELECT 
		  appraisal_id,
		  COUNT(DISTINCT user_id) AS favoriteCount,
		  SUM(CASE user_id WHEN #{userId,jdbcType=VARCHAR} THEN 1 ELSE 0 END) AS favoriteFlag
		FROM
		  zc_appraisal_favorite 
		WHERE is_vaild = 1 
		GROUP BY appraisal_id ) t_af
	    ON t_a.appraisal_id = t_af.appraisal_id 
	  LEFT JOIN (SELECT 
		  appraisal_id,
		  GROUP_CONCAT(DISTINCT tag) AS tag
		FROM
		  zc_appraisal_tag 
		WHERE is_vaild = 1 
		GROUP BY appraisal_id ) t_at 
	    ON t_a.appraisal_id = t_at.appraisal_id 
	  LEFT JOIN (SELECT 
		  appraisal_id,
		  SUBSTRING_INDEX(
		    GROUP_CONCAT(DISTINCT img_url 
		      ORDER BY pk_id ASC),
		    ',',
		    1
		  ) AS img 
		FROM
		  zc_appraisal_img 
		GROUP BY appraisal_id ) t_ai 
	    ON t_a.appraisal_id = t_ai.appraisal_id 
	  LEFT JOIN cms_user t_cr 
	    ON t_a.create_by = t_cr.user_id 
	  LEFT JOIN (SELECT 
		  t_ac.appraisal_id ,
		  GROUP_CONCAT(DISTINCT t_c.commodity_name) AS commodityName,
		  GROUP_CONCAT(DISTINCT t_b.brand_name) AS brandName 
		FROM
		  zc_appraisal_commodity t_ac 
		  LEFT JOIN zc_commodity t_c 
		    ON t_ac.commodity_id = t_c.commodity_id 
		  LEFT JOIN zc_brand t_b 
		    ON t_c.brand_id = t_b.brand_id 
		WHERE t_ac.is_vaild = 1 
		GROUP BY t_ac.appraisal_id ) t_ac 
	    ON t_a.appraisal_id = t_ac.appraisal_id 
	WHERE t_a.is_valid = 1 
	<if test="null != brandId or null != commodityId">
		AND t_a.appraisal_id in (SELECT DISTINCT 
			  t_ac.appraisal_id 
			FROM
			  zc_appraisal_commodity t_ac 
			  LEFT JOIN zc_commodity t_c 
			    ON t_ac.commodity_id = t_c.commodity_id 
			  LEFT JOIN zc_brand t_b 
			    ON t_c.brand_id = t_b.brand_id 
			WHERE t_ac.is_vaild = 1 
			<if test="null != brandId and '' != brandId">
				AND t_b.brand_id = #{brandId,jdbcType=VARCHAR}
			</if>
			<if test="null != commodityId and '' != commodityId">
				AND t_c.commodity_id =#{commodityId,jdbcType=VARCHAR}
			</if>
		)
	</if>
	<if test="null != appreciateBy and '' != appreciateBy">
		AND t_aa.appreciateFlag &gt; 0
	</if>
	<if test="null != favoriteBy and '' != favoriteBy">
		AND t_af.favoriteFlag &gt; 0
	</if>
	<if test="null != search and '' != search">
		AND (
			t_a.title LIKE CONCAT('%',#{search,jdbcType=VARCHAR},'%')
			OR t_at.tag LIKE CONCAT('%',#{search,jdbcType=VARCHAR},'%')
			OR t_ac.commodityName LIKE CONCAT('%',#{search,jdbcType=VARCHAR},'%')
			OR t_ac.brandName LIKE CONCAT('%',#{search,jdbcType=VARCHAR},'%')
			)
	</if>
  </select>
</mapper>